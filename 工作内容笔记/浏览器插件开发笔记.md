[toc]

# CRXJS+Vite+Vue+Tsåˆ›å»ºæ‰©å±•é¡¹ç›®

## 1ã€åˆ›å»ºviteé¡¹ç›®

æ‰¾åˆ°å·¥ä½œç›®å½•ï¼Œæ‰“å¼€`cmd`å‘½ä»¤çª—å£ï¼Œè¾“å…¥ä»¥ä¸‹å‘½ä»¤

```bash
pnpm init vite@latest
```

è¾“å…¥é¡¹ç›®åç§°ï¼Œé€‰æ‹©`Vue`å’Œ`TypeScript`ã€‚

<img src="./assets/image-20241107103406805.png" alt="image-20241107103406805" style="zoom: 67%;" />

## 2ã€åˆ›å»ºManifest.json

è¿›å…¥åˆ°é¡¹ç›®æ–‡ä»¶å¤¹ä¸­ï¼Œåˆ›å»º`manifest.json`æ–‡ä»¶ï¼Œå¯ä»¥ç®€å•é…ç½®ä¸€äº›å†…å®¹ï¼š

```json
{
    "manifest_version": 3,
    "name": "CRXJS Vue Vite Example",
    "description": "A simple example of using CRXJS with Vue and Vite",
    "version": "1.0.0",
    "action": {
      "default_popup": "index.html"
    },
    "content_scripts": [
        {
            "matches": ["https://www.baidu.com/**"],
            "js": ["src/content/content.ts"]
        }
    ],
    "background": {
        "service_worker": "src/background/background.ts"
    }
}
```

å½“è¿›å…¥åˆ°`www.baidu.com`é¡µé¢æ—¶ï¼Œ`src/content/content.ts`æ–‡ä»¶ä¼šæ‰§è¡Œï¼ˆæ–‡ä»¶å’Œç›®å½•è‡ªè¡Œåˆ›å»ºï¼‰ã€‚

`src/background/background.ts`åˆ™ä¼šä¸€ç›´åœ¨åå°æ‰§è¡Œã€‚

## 3ã€é…ç½®ç¯å¢ƒ

è¿›å…¥åˆ°é¡¹ç›®æ–‡ä»¶å¤¹ä¸­ï¼Œå®‰è£…ä¾èµ–:

```bash
pnpm i
```

### 3.1 CRXJSé…ç½®

å®‰è£…`crxjs`ï¼š

```bash
pnpm i @crxjs/vite-plugin@beta -D
```

æ‰¾åˆ°é¡¹ç›®ä¸­çš„`vite.config.ts`æ–‡ä»¶ï¼Œé…ç½®ä»¥ä¸‹å†…å®¹ï¼š

```ts
import { defineConfig } from 'vite'
import vue from '@vitejs/plugin-vue'
import { crx } from '@crxjs/vite-plugin'
import manifest from './manifest.json' assert { type: 'json' } // Node >=17

// https://vitejs.dev/config/
export default defineConfig({
  plugins: [
    vue(),
    crx({ manifest }),
  ],
})
```

### 3.2 ElementPlusé…ç½®

å®‰è£…`ElementPlus`:

```bash
pnpm i element-plus -D
```

æ‰¾åˆ°`src`ç›®å½•ä¸‹çš„`main.ts`æ–‡ä»¶é…ç½®ä»¥ä¸‹å†…å®¹ï¼š

```ts
import { createApp } from 'vue'
import './style.css'
import App from './App.vue'
import ElementPlus from 'element-plus'
import 'element-plus/dist/index.css'

createApp(App).use(ElementPlus).mount('#app')
```

### 3.3 chromeé…ç½®

å®‰è£…`chrome-types`:

```bash
pnpm i chrome-types -D
```

æ‰¾åˆ°`src`ç›®å½•ä¸‹çš„`vite-env.d.ts`æ–‡ä»¶ï¼Œæ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š

```ts
/// <reference types="chrome-types/index" />
```

è¿™æ ·ä¸è®ºæ˜¯åœ¨`vue`æ–‡ä»¶ä¸­è¿˜æ˜¯åœ¨`ts`æ–‡ä»¶ä¸­ï¼Œä½¿ç”¨`chrome`æ—¶éƒ½ä¼šæœ‰ç›¸åº”çš„æç¤ºï¼š

<img src="./assets/image-20241107104300683.png" alt="image-20241107104300683" style="zoom:80%;" />

## 4ã€å¯åŠ¨é¡¹ç›®

```bash
pnpm run dev
```

å‘½ä»¤æ‰§è¡Œåä¼šåœ¨é¡¹ç›®ä¸­ç”Ÿæˆ`dist`æ–‡ä»¶å¤¹ï¼š

<img src="./assets/image-20241107105031426.png" alt="image-20241107105031426" style="zoom:80%;" />

ä½¿ç”¨`chrome`æµè§ˆå™¨å°†è¯¥æ–‡ä»¶å¤¹åŠ è½½è¿›æ¥ï¼š

<img src="./assets/image-20241107105051736.png" alt="image-20241107105051736" style="zoom:80%;" />

# endã€é‡åˆ°çš„å‘

## 1ã€chrome.storage.localæœªå®šä¹‰

åœ¨`manifest.json`ä¸­é…ç½®æƒé™ï¼š

```json
"permissions": [
    "storage"
],
```

åˆ é™¤`dist`æ–‡ä»¶å¤¹ï¼Œå¹¶ä¸”åœ¨æµè§ˆå™¨æ’ä»¶ä¸­ç§»é™¤æ‰è¯¥æ’ä»¶ï¼Œé‡æ–°æ‰§è¡Œ

```basg
pnpm run dev
```

å¹¶å°†`dist`é‡æ–°å¯¼å…¥åˆ°æµè§ˆå™¨æ’ä»¶ä¸­å³å¯ã€‚

## 2ã€tsæ–‡ä»¶ä¸­æ— æ³•ä½¿ç”¨chrome.runtime.sendMessage({ })

å®‰è£…ï¼š

```bash
pnpm i @types/chrome -D
```

é‡æ–°å¯åŠ¨ã€‚

## 3ã€æŠ¥é”™Failed to construct 'WebSocket'

åœ¨`vite.config.ts`ä¸­æ·»åŠ ï¼š

```typescript
server: {
    port: 5173,
    strictPort: true,
    hmr: {
      port: 5173,
	},	
},
```



# Piniaä½¿ç”¨æ–¹æ³•

## 1ã€å®‰è£…pinia

```bash
yarn add pinia
# æˆ–è€…ä½¿ç”¨ npm
npm install pinia
# æˆ–è€…ä½¿ç”¨ pnpm
pnpm install pinia
```

## 2ã€åˆ›å»ºpiniaå®ä¾‹

```js
import { createApp } from 'vue'
import { createPinia } from 'pinia'
import App from './App.vue'

const pinia = createPinia()
const app = createApp(App)

app.use(pinia)
app.mount('#app')
```

## 3ã€Store

### 3.1ã€å®šä¹‰Store

 `Store` æ˜¯ç”¨ `defineStore()` å®šä¹‰çš„ï¼Œå®ƒçš„ç¬¬ä¸€ä¸ªå‚æ•°è¦æ±‚æ˜¯ä¸€ä¸ª**ç‹¬ä¸€æ— äºŒ**çš„åå­—ï¼š

```js
import { defineStore } from 'pinia'

// ä½ å¯ä»¥ä»»æ„å‘½å `defineStore()` çš„è¿”å›å€¼ï¼Œä½†æœ€å¥½ä½¿ç”¨ store çš„åå­—ï¼ŒåŒæ—¶ä»¥ `use` å¼€å¤´ä¸”ä»¥ `Store` ç»“å°¾ã€‚
// (æ¯”å¦‚ `useUserStore`ï¼Œ`useCartStore`ï¼Œ`useProductStore`)
// ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä½ çš„åº”ç”¨ä¸­ Store çš„å”¯ä¸€ IDã€‚
export const useAlertsStore = defineStore('alerts', {
  // å…¶ä»–é…ç½®...
})
```

### 3.2ã€Option Store

```js
export const useCounterStore = defineStore('counter', {
  state: () => ({ count: 0, name: 'Eduardo' }),
  getters: {
    doubleCount: (state) => state.count * 2,
  },
  actions: {
    increment() {
      this.count++
    },
  },
})
```

==å¯ä»¥è®¤ä¸º `state` æ˜¯ store çš„æ•°æ® (`data`)ï¼Œ`getters` æ˜¯ store çš„è®¡ç®—å±æ€§ (`computed`)ï¼Œè€Œ `actions` åˆ™æ˜¯æ–¹æ³• (`methods`)ã€‚==

### 3.3ã€Setup Store

å¯ä»¥ä¼ å…¥ä¸€ä¸ªå‡½æ•°ï¼Œè¯¥å‡½æ•°å®šä¹‰äº†ä¸€äº›å“åº”å¼å±æ€§å’Œæ–¹æ³•ï¼Œå¹¶ä¸”è¿”å›ä¸€ä¸ªå¸¦æœ‰æˆ‘ä»¬æƒ³æš´éœ²å‡ºå»çš„å±æ€§å’Œæ–¹æ³•çš„å¯¹è±¡ã€‚

```js
export const useCounterStore = defineStore('counter', () => {
  const count = ref(0)
  const doubleCount = computed(() => count.value * 2)
  function increment() {
    count.value++
  }

  return { count, doubleCount, increment }
})
```

åœ¨ *Setup Store* ä¸­ï¼š

- `ref()` å°±æ˜¯ `state` å±æ€§
- `computed()` å°±æ˜¯ `getters`
- `function()` å°±æ˜¯ `actions`

### 3.4ã€ä½¿ç”¨Store

å‰é¢å®šä¹‰äº†ä¸€ä¸ª `store`ï¼Œä½†åœ¨æˆ‘ä»¬ä½¿ç”¨ `<script setup>` è°ƒç”¨ `useStore()`(æˆ–è€…ä½¿ç”¨ `setup()` å‡½æ•°ï¼Œ**åƒæ‰€æœ‰çš„ç»„ä»¶é‚£æ ·**) ä¹‹å‰ï¼Œ`store` å®ä¾‹æ˜¯ä¸ä¼šè¢«åˆ›å»ºçš„ã€‚è¯·æ³¨æ„ï¼Œ`store` æ˜¯ä¸€ä¸ªç”¨ `reactive` åŒ…è£…çš„å¯¹è±¡ï¼Œè¿™æ„å‘³ç€ä¸éœ€è¦åœ¨ getters åé¢å†™ `.value`ã€‚å°±åƒ `setup` ä¸­çš„ `props` ä¸€æ ·ï¼Œ**æˆ‘ä»¬ä¸èƒ½å¯¹å®ƒè¿›è¡Œè§£æ„**ï¼š

```js
<script setup>
import { useCounterStore } from '@/stores/counter'
import { computed } from 'vue'

const store = useCounterStore()
// âŒ è¿™å°†ä¸èµ·ä½œç”¨ï¼Œå› ä¸ºå®ƒç ´åäº†å“åº”æ€§
// è¿™å°±å’Œç›´æ¥è§£æ„ `props` ä¸€æ ·
const { name, doubleCount } = store
name // å°†å§‹ç»ˆæ˜¯ "Eduardo"
doubleCount // å°†å§‹ç»ˆæ˜¯ 0
setTimeout(() => {
  store.increment()
}, 1000)
// âœ… è¿™æ ·å†™æ˜¯å“åº”å¼çš„
// ğŸ’¡ å½“ç„¶ä½ ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨ `store.doubleCount`
const doubleValue = computed(() => store.doubleCount)
</script>
```

ä¸ºäº†ä» `store` ä¸­æå–å±æ€§æ—¶ä¿æŒå…¶å“åº”æ€§ï¼Œä½ éœ€è¦ä½¿ç”¨ `storeToRefs()`ã€‚

```js
<script setup>
import { storeToRefs } from 'pinia'

const store = useCounterStore()
// `name` å’Œ `doubleCount` æ˜¯å“åº”å¼çš„ ref
// åŒæ—¶é€šè¿‡æ’ä»¶æ·»åŠ çš„å±æ€§ä¹Ÿä¼šè¢«æå–ä¸º ref
// å¹¶ä¸”ä¼šè·³è¿‡æ‰€æœ‰çš„ action æˆ–éå“åº”å¼ (ä¸æ˜¯ ref æˆ– reactive) çš„å±æ€§
const { name, doubleCount } = storeToRefs(store)
// ä½œä¸º action çš„ increment å¯ä»¥ç›´æ¥è§£æ„
const { increment } = store
</script>
```

# Chrome-extension-vue-04å¼€å‘ç¬”è®°

## 1ã€ä¾èµ–å®‰è£…

### 1.1 å®‰è£…å‘½ä»¤

```
pnpm i @crxjs/vite-plugin @types/chrome axios chrome-types docx echarts file-saver html2canvas lodash-es markdown-it pinia -D
```

### 1.2 package.json

```json
{
  "name": "chrome-extension-vue-04",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "vue-tsc -b && vite build",
    "preview": "vite preview"
  },
  "dependencies": {
    "vue": "^3.5.12"
  },
  "devDependencies": {
    "@crxjs/vite-plugin": "2.0.0-beta.28",
    "@element-plus/icons-vue": "^2.3.1",
    "@vitejs/plugin-vue": "^5.1.4",
    "axios": "^1.7.7",
    "chrome-types": "^0.1.320",
    "docx": "^9.0.3",
    "echarts": "^5.5.1",
    "element-plus": "^2.8.7",
    "file-saver": "^2.0.5",
    "html2canvas": "^1.4.1",
    "lodash-es": "^4.17.21",
    "markdown-it": "^14.1.0",
    "pinia": "^2.2.6",
    "typescript": "~5.6.2",
    "vite": "^5.4.10",
    "vue-tsc": "^2.1.8"
  }
}
```

## 2ã€è·¯å¾„é…ç½®

### 2.1 ä½¿ç”¨`@`ç¬¦å·å¼•å¯¼è·¯å¾„

```typescript
# vite.config.ts

import { defineConfig } from 'vite'
import vue from '@vitejs/plugin-vue'
import { crx } from '@crxjs/vite-plugin'
import manifest from './manifest.json' assert { type: 'json' }


export default defineConfig({
  plugins: [
    vue(),
    crx({ manifest }),
  ],
   
  // ä½¿ç”¨ @ ä½œä¸º /src çš„åˆ«å
  resolve: {
    alias: [
      {
        find: '@',
        replacement: '/src'
      }
    ]
  }
})
```

